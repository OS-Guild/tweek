version: '1.0'
steps:
  BuildingCompiler:
    type: build
    image_name: soluto/aspnetcore-build
    working_directory: ./CI
    
  CompilingApi:
    title: Compiling Tweek Api Solution
    image: ${{BuildingCompiler}}
    commands: 
      - cd CI && envsubst < ./NuGet.Config.tmpl > NuGet.Config
      - dotnet restore ./Tweek.sln --configfile ./CI/NuGet.Config
      - dotnet publish ./Tweek.sln -c Release -o ./obj/Docker/publish
      - cp ./services/api/Tweek.ApiService.NetCore/Dockerfile ./services/api/Tweek.ApiService.NetCore/obj/Docker/publish/Dockerfile
      - echo Dockerfile > ./services/api/Tweek.ApiService.NetCore/obj/Docker/publish/.dockerignore

  BuildingDockerImage:
    title: Building Docker Image
    type: build
    image_name: soluto/tweek-api
    working_directory: ${{main_clone}}/services/api/Tweek.ApiService.NetCore/obj/Docker/publish
    build_arguments: 
      - source=.
